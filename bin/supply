#!/bin/bash
set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`
output_dir=$(mktemp -d -t supplyXXX)

echo "-----> Running Shim Supply"

version=$(cat "$BUILDPACK_DIR/SHIM_VERSION")
wget -O "$output_dir/shim-bundle-$version.tgz" "https://buildpacks.cloudfoundry.org/dependencies/shim-bundle/shim-bundle-$version.tgz" &>/dev/null
tar xvf "$output_dir/shim-bundle-$version.tgz" -C "$output_dir" &>/dev/null


$output_dir/supply "$BUILD_DIR" "$CACHE_DIR" "$DEPS_DIR" "$DEPS_IDX"
